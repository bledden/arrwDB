version: '3.8'

services:
  # arrwDB API - Production Configuration
  arrwdb-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: arrwdb-prod
    ports:
      - "8000:8000"
    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - PORT=8000
      - LOG_LEVEL=INFO
      - LOG_JSON_FORMAT=true

      # Gunicorn Production Settings
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}
      - GUNICORN_MAX_REQUESTS=10000
      - GUNICORN_MAX_REQUESTS_JITTER=1000
      - GUNICORN_TIMEOUT=120

      # Multi-Tenancy (enabled for production)
      - MULTI_TENANCY_ENABLED=true
      - TENANTS_DB_PATH=/app/data/tenants.json

      # Rate Limiting (enabled for production)
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_PER_MINUTE=60
      - RATE_LIMIT_BURST=10

      # Embedding Service
      - COHERE_API_KEY=${COHERE_API_KEY}
      - EMBEDDING_MODEL=embed-english-v3.0
      - EMBEDDING_DIMENSION=1024

      # Performance Settings
      - MAX_CHUNK_SIZE=1000
      - MAX_CHUNKS_PER_DOCUMENT=1000
      - MAX_CONCURRENT_REQUESTS=100

      # Event Bus & Job Queue
      - EVENT_BUS_ENABLED=true
      - JOB_QUEUE_ENABLED=true
      - JOB_QUEUE_MAX_WORKERS=8
      - JOB_QUEUE_MAX_RETRIES=3

      # WebSocket
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_MAX_CONNECTIONS=1000

      # Data persistence
      - VECTOR_DB_DATA_DIR=/app/data

      # Security
      - CORS_ENABLED=true
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - METRICS_ENABLED=true

    volumes:
      # Persist data directory (use named volume for production)
      - arrwdb-prod-data:/app/data

      # Persist logs
      - arrwdb-prod-logs:/app/logs

    command: >
      gunicorn app.api.main:app
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --workers ${GUNICORN_WORKERS:-4}
      --max-requests 10000
      --max-requests-jitter 1000
      --timeout 120
      --access-logfile /app/logs/access.log
      --error-logfile /app/logs/error.log
      --log-level info

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: always

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

    networks:
      - arrwdb-prod-network

  # Prometheus for Metrics (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: arrwdb-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - arrwdb-prod-network
    profiles:
      - monitoring

  # Grafana for Visualization (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: arrwdb-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - arrwdb-prod-network
    profiles:
      - monitoring

volumes:
  arrwdb-prod-data:
    driver: local
  arrwdb-prod-logs:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

networks:
  arrwdb-prod-network:
    driver: bridge
    name: arrwdb-prod-network
